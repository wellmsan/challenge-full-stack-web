language: node_js
node_js:
  - "12"

sudo: required

services:
  - docker

before_script:
  - mkdir /app
  - cp . /app
  - cp ./back/package.json /app/back/package.json
  - cp ./back/start.sh /app/back/start.sh
  - chmod 777 /app/back/start.sh
  - cp ./front/package.json /app/front/package.json
  - cp ./front/start.sh /app/front/start.sh
  - chmod 777 /app/front/start.sh
  - npm install  

env:
  global:
    - REGISTRY_USER=${REGISTRY_USER}
    - REGISTRY_PASS=${REGISTRY_PASS}

jobs:
  include:
    - stage: build BackEnd
      script:
      - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin $REGISTRY_URL
      #- docker login -u $DOCKER_USERNAME --password-stdin $REGISTRY_URL
      - docker build --file ./back/Dockerfile --no-cache -t $REGISTRY_URL/grupoa-back .
      - docker push $REGISTRY_URL/grupoa-back
    - stage: test
      script:
      - cd /back
      - npm run test
    - stage: deploy BackEnd
      script:
      - docker stack deploy -c ./back/docker-compose.yml grupo-a
    - stage: build FrontEnd
      script:
      - docker login -u $REGISTRY_USER -p $REGISTRY_PASS $REGISTRY_URL
      - docker build --file ./back/Dockerfile --no-cache -t $REGISTRY_URL/grupoa-front .
      - docker push $REGISTRY_URL/grupoa-front
    - stage: deploy FrontEnd
      script:
      - docker stack deploy -c ./front/docker-compose.yml grupo-a
